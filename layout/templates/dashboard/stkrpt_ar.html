{% load static %}
<style>
  #arpWrapper {
    position: relative;
    width: 100%;
    min-height: 800px;
  }
  .overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1;
  }
  .spanner {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 42.5%;
    text-align: center;
    z-index: 2;
  }

  #arpSuccess {
    display: none;
  }

  .table-responsive {
    height: 700px;
    max-height: 700px;
  }

  .fix-header {
    position: sticky;
    top: 0;
    background: white;
  }

  #arpFailed {
    display: none;
  }

  .chart-container {
    position: relative;
  }
</style>

<div class="mb-3" id="arViewer">
  <div class="mb-5" id="arViewerHeader">
    <h4 class="mb-3 fw-bold">재무비율 분석</h4>
    <p class="text-lead text-muted fs-5">재무비율 정의, 의미 (안정성, 수익성, 성장성, ...), 재무비율 분석의 중요성, Lorem ipsum dolor sit amet, consectetur adipisicing elit. Ullam ex quae, impedit praesentium, iusto obcaecati qui eos iure alias, voluptates veniam harum amet error voluptate, assumenda est nihil quisquam. Quas!...  <a href="#">더보기</a></p>
  </div>
  <div class="mb-5" id="arLatest">
    <h5 class="mb-3 fw-bold"><i class="bi bi-chevron-double-right text-secondary"></i> 재무비율 현황 상세</h5>
    <div id="larTable">
      <table class="table">
        <thead>
          <tr>
            <th>재무비율명</th>
            <th>구분</th>
            <th>기준일</th>
            <th>값</th>
            <th>전기 대비</th>
            <th>전년 동기 대비</th>
            <th>평년 대비</th>
            <th>시장 평균 대비</th>
          </tr>
        </thead>
        <tbody>
          {% for larv in ar_viewer.larv_all %}
          <tr>
            <td>{{ larv.ar.labelKor }}</td>
            <td>{{ larv.ar.div }}</td>
            <td>{% if larv.fqe %}{{ larv.fqe|date:"Y-m-d" }}{% else %}-{% endif %}</td>
            <td class="fw-bold">{% if larv.value %}{{ larv.value|floatformat:"4" }}{% else %}-{% endif %}</td>
            {% if larv.tdev_q1 %}
            <td class="text-{% if larv.tdev_q1 > 1 %}danger{% elif larv.tdev_q1 == 1 %}dark{% elif larv.tdev_q1 < 1 %}primary{% endif %}">{{ larv.tdev_q1|floatformat:"2" }}배</td>
            {% else %}
            <td>-</td>
            {% endif %}
            {% if larv.tdev_y1 %}
            <td class="text-{% if larv.tdev_y1 > 1 %}danger{% elif larv.tdev_y1 == 1 %}dark{% elif larv.tdev_y1 < 1 %}primary{% endif %}">{{ larv.tdev_y1|floatformat:"2" }}배</td>
            {% else %}
            <td>-</td>
            {% endif %}
            {% if larv.tdev %}
            <td class="text-{% if larv.tdev > 1 %}danger{% elif larv.tdev == 1 %}dark{% elif larv.tdev < 1 %}primary{% endif %}">{{ larv.tdev|floatformat:"2" }}배</td>
            {% else %}
            <td>-</td>
            {% endif %}
            {% if larv.pdev %}
            <td class="text-{% if larv.pdev > 1 %}danger{% elif larv.pdev == 1 %}dark{% elif larv.pdev < 1 %}primary{% endif %}">{{ larv.pdev|floatformat:"2" }}배</td>
            {% else %}
            <td>-</td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <caption>
        <p class="form-text mb-1">* OPEN DART에 제출된 {{ corp.corpName }}의 연결재무제표로부터 산출된 재무비율의 현황을 나타냅니다.</p>
        <p class="form-text mb-1">* 재무비율 및 재무비율 관련 지표는 다음 사유로 결측될 수 있습니다: <a href="#">결측 사유 보러가기</a>.</p>
        <p class="form-text mb-1">
          * 전기 대비, 전년 동기 대비, 평년 대비, 시장 평균 대비 항목은 비교 대상과 해당 종목의 기준일 값 사이의 비율을 나타냅니다.
          비교 대상의 값이 1이고 해당 종목의 기준일 값이 1.1이라면 '1.1배'를 표시하며 '10% 증가' 혹은 '+10% 편차'와 동일한 의미를 가집니다. 반대로 0.9라면 '0.9배'를 표시하며 '10% 감소' 혹은 '-10% 편차'와 동일한 의미를 가집니다.
        </p>
        <p class="form-text mb-1">* 전기 대비 =  (기준일 값) / (직전 분기 값)</p>
        <p class="form-text mb-1">* 전년 동기 대비 = (기준일 값) / (직전 회계년도 동일 분기 값)</p>
        <p class="form-text mb-1">* 평년 대비 = (기준일 값) / (해당종목 전기간 평균값)</p>
        <p class="form-text mb-1">* 시장 평균 대비 = (기준일 값) / ({{ corp.market }} 전종목 전기간 평균값)</p>
      </caption>
    </div>
  </div>
  <div class="mb-5" id="arPanel">
    <h5 class="mb-3 fw-bold"><i class="bi bi-chevron-double-right text-secondary"></i> 재무비율별 변동 및 시점별 분포</h5>
    <p class="text-lead text-muted fs-5">{{ corp.corpName }}의 분기별 재무비율 변동 및 각 시점별 {{ corp.market }} 상장사의 재무비율 분포 정보를 조회합니다.</p>
    <!-- select chart -->
    <div id="selectAr">
      <div class="d-flex flex-row">
        <!-- select method     -->
        <div class="input-group mb-3">
          <span class="input-group-text" id="tsMethod-addon">재무제표 구분</span>
          <div class="form-control d-flex justify-content-center" aria-describedby="tsMethod-addon">
            {% for oc in ar_viewer.select_form.oc_choices %}
            <div class="form-check form-check-inline">
              <input type="radio" class="form-check-input" onclick="updateArpStatic()" name="oc" value="{{ oc }}" {% if forloop.first %}checked{% endif %}>
              <label for="{{ oc }}" class="form-check-label" >{% if oc == 'CFS' %}연결{% else %}별도{% endif %}</label>
            </div>
            {% endfor %}
          </div>
        </div>
        <!-- select ar -->
        <div class="input-group mb-3">
          <span class="input-group-text" id="arName-addon">재무비율 선택</span>
          <select name="arName" id="arName" class="form-select" aria-describedby="arName-addon" onchange="updateArpStatic()">
            {% for ar in ar_viewer.select_form.ar_choices %}
            <option class="text-center" value="{{ ar.name }}" {% if ar.name == 'ReturnOnEquity' %}selected{% endif %}>{{ ar.labelKor }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    <div class="formbox mb-3" id="arAbstract">
      <h6>[ar name]</h6>
      <p>[abstract] Lorem ipsum dolor sit amet, consectetur adipisicing elit. Provident voluptatum praesentium laborum quod, qui natus nobis tempore sint error, optio minima illum! Illo cupiditate a quos dolore hic, ipsa. Mollitia. <a href="#">show more</a></p>
    </div>

    <!-- ar panel plot area -->
    <div id="arpWrapper">
      <div class="overlay"></div>
      <div class="spanner">
        <div class="spinner-grow text-light mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <p class="text-light fw-bold">데이터베이스 조회중</p>
      </div>
      <div style="min-height: 800px;">
        <div id="arpSuccess">
          <div class="row">
            <div class="row col-8" id="arpChart">
              <div class="chart-container">
                <canvas id="arpTsChart"></canvas>
              </div>
              <div class="chart-container">
                <canvas id="arpDistChart"></canvas>
              </div>
            </div>
            <div class="col-4 table-responsive" style="min-height: 800px;">
              <table class="table table-hover text-nowrap" id="arpChartControl">
                <thead class="fix-header">
                  <tr>
                    <th style="width: 20%">날짜</th>
                    <th style="width: 20%">값</th>
                    <th style="width: 15%">순위</th>
                    <th style="width: 20%;">백분위</th>
                    <th style="width: 25%;">평가</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="formbox position-relative" id="arpFailed" style="min-height: 800px;">
          <p class="position-absolute top-50 start-50 translate-middle text-muted fs-2">조회 가능한 계열이 존재하지 않습니다.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-5" id="singleFaViewer">
    <h5 class="mb-3 fw-bold"><i class="bi bi-chevron-double-right text-secondary"></i> 재무계정별 변동</h5>
    <div>
      <table class="table table-hover" id="faChartControl">
        <caption id="faSearchResult">
        </caption>
        <thead>
          <tr>
            <th scope="col" style="width: 5%"></th>
            <th scope="col" style="width: 10%">구분</th>
            <th scope="col" style="width: 25%">계정명</th>
            <th scope="col" style="width: 40%">표준경로</th>
            <th scope="col" style="width: 10%">상태</th>
            <th scope="col" style="width: 5%">값</th>
            <th scope="col" style="width: 5%">변동율</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th scope="row">
              <button class="btn btn-outline-primary" id="activateFaSearchBtn" onclick="faSearch()">
                <i class="bi bi-plus-lg"></i>
              </button>
            </th>
            <td id="selectCell">-</td>
            <td id="searchCell">-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
          </tr>
        </tfoot>
      </table>
    </div>
    <canvas id="faChart"></canvas>
  </div>


  <div class="mb-5" id="customArViewer">
    {% include './stkrpt_ar_custom_ar.html' %}
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // global variables
  const stockCode = "{{ corp.stockCode }}"
  function dateFormatter(ts) {
    var date = new Date(ts);
    var strYear = date.getFullYear().toString();
    var strMonth = (date.getMonth()+1).toString().padStart(2,'0')
    var strDate = date.getDate().toString().padStart(2,'0')
    return `${strYear}-${strMonth}-${strDate}`
  };
  function hexToRgb(hex, alpha) {
    let r = parseInt(hex.slice(1, 3), 16),
      g = parseInt(hex.slice(3, 5), 16),
      b = parseInt(hex.slice(5, 7), 16);

    if (0 <= alpha && alpha <= 1) {
      return `rgba(${r}, ${g}, ${b}, ${alpha})`
    } else {
      return `rgb(${r}, ${g}, ${b})`
    }
  }
</script>
<script>
  // ar panel charts
  const arpChartColors = ['#457CA2', "#DC3912", "#FF9900", "#109618"]

  // ar time series chart
  // marker and line
  const arpTsChartConfig = {
    type: 'scatter',
    data: {
      labels: [],
      datasets: [],
    },
    options: {
      plugins: {
        legend: {
          labels: {
            filter: function(item, data) {
              return !item.text.includes('Line')
            }
          }
        }
      }
    },
  };
  const arpTsChart = new Chart(
    document.getElementById('arpTsChart'),
    arpTsChartConfig
  );

  // ar distribution chart
  // bar and line
  const arpDistChartConfig = {
    type: 'scatter',
    data: {
      labels: [],
      datasets: [],
    },
    options: {
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          grid: {
            drawOnChartArea: false,
          },
        },
        x: {
          type: 'linear',
        }
      },
      plugins: {
        legend: {
          display: false,
        }
      },
    }
  };
  const arpDistChart = new Chart(
    document.getElementById('arpDistChart'),
    arpDistChartConfig
  );

  var arpWs;
  var arpStaticData;
  function activateArpSpinner() {
    $('.overlay').each(function(i, overlay) {
      overlay.style.display = 'block';
    });
    $('.spanner').each(function(i, spinner) {
      spinner.style.display = 'block';
    });
  };
  function resetArpAll() {
    return new Promise(function(resolve) {
      // close web socket
      if (arpWs !== undefined) {
        arpWs.close();
      };

      // reset data
      if (arpStaticData !== undefined) {
        arpStaticData = undefined
      };
      if (arpDynamicDataSets !== []) {
        arpDynamicDataSets = []
      };

      // reset charts
      arpTsChart.data.labels = [];
      arpTsChart.data.datasets = [];
      arpTsChart.update();

      arpDistChart.data.labels = [];
      arpDistChart.data.datasets = [];
      arpDistChart.update();

      resolve();
    });
  };
  function createArpWs() {
    return new Promise(function(resolve) {
      arpWs = new WebSocket(
        `ws://${window.location.host}/ws/dashboard/stkrpt/ar`
      );
      resolve();
    });
  };
  function sendArpStaticInputs() {
    return new Promise(function(resolve, reject) {
      let staticInputs = {
        requestType: 'static',
        stockCode: "{{ corp.stockCode }}",
        oc: $("input[name=oc]:checked").val(),
        arName: $("#arName").val(),
      };
      arpWs.onopen = function() {
        arpWs.send(JSON.stringify(staticInputs))
      };
      resolve();
    });
  };
  function receiveArpStaticData() {
    return new Promise(function(resolve, reject) {
      arpWs.onmessage = function(e) {
        arpStaticData = JSON.parse(e.data);
        if (arpStaticData !== null) {
          resolve()
          // arpChartData = newData.graph_data;
          // resolve([ws, newData]);
        } else {
          reject(new Error("no data"));
        };
      };
    });
  };
  function updateArpStaticContents() {
    return new Promise(function(resolve) {
      // parsing data
      let timeHorizon = JSON.parse(arpStaticData.t);
      let timeSeries = JSON.parse(arpStaticData.val);

      // update ts chart
      arpTsChart.data.labels = timeHorizon.map(tp => dateFormatter(tp));
      arpTsChart.data.datasets.push({
        type: 'line',
        label: 'valLine',
        data: timeSeries,
        borderColor: hexToRgb(arpChartColors[1], 1),
        pointRadius: 3,
      })
      arpTsChart.update();
      // update table
      let tpColumn = timeHorizon.slice().reverse();
      let valColumn = timeSeries.slice().reverse();
      $('#arpChartControl tbody tr').remove();
      for (let [i, tp] of tpColumn.entries()) {
        let rowColor = (i === 0) ? 'table-active':'';
        let rowVal = (valColumn[i] === null) ? '-':valColumn[i].toFixed(4)
        $('#arpChartControl tbody').append(`
          <tr class="${rowColor}" tp="${tp}" onclick="updateArpDynamic(this)">
            <td>${dateFormatter(tp)}</td>
            <td class="fw-bold">${rowVal}</td>
            <td class="text-center text-muted result-cell" colspan="3">조회하기</td>
          </tr>
        `)
      };
      resolve();
    });
  };
  function deactivateArpSpinner() {
    $('.overlay').each(function(i, overlay) {
      overlay.style.display = 'none';
    });
    $('.spanner').each(function(i, spinner) {
      spinner.style.display = 'none';
    });
  };
  function viewArpSuccess() {
      $('#arpSuccess')[0].style.display = 'block';
      $('#arpFailed')[0].style.display = 'none';
      deactivateArpSpinner();
  };
  function viewArpFail() {
    $('#arpSuccess')[0].style.display = 'none';
    $('#arpFailed')[0].style.display = 'block';
    deactivateArpSpinner();
  };
  function triggerFirstDynamicRow() {
    $('#arpChartControl tbody .table-active').trigger('click');
  };
  function updateArpStatic() {
    activateArpSpinner();
    resetArpAll()
    .then(() => createArpWs())
    .then(() => sendArpStaticInputs())
    .then(() => receiveArpStaticData())
    .then(() => updateArpStaticContents())
    .then(() => viewArpSuccess())
    .then(() => triggerFirstDynamicRow())
    .catch(function(err) {
      viewArpFail();
    });
  };

  var arpDynamicDataSets = [];
  function deactivateArpControl(e) {
    return new Promise(function(resolve) {
      $('#arpChartControl tbody tr').removeClass();
      e.classList.add('table-active');
      let resultCells = e.getElementsByClassName('result-cell')[0];
      resultCells.innerHTML = `
        <div class="spinner-grow spinner-grow-sm text-success" role="status"></div>
      `;
      resolve();
    });
  };
  function getArpDynamicData(e) {
    return new Promise(function(resolve) {
      let tp = $(e).attr('tp');
      let ds = arpDynamicDataSets.find(ds => ds.tp === parseInt(tp));
      if (ds === undefined) {
        ds = sendArpDynamicInputs(e)
          .then(() => receiveArpDynamicData())
      };
      resolve(ds);
    });
  };
  function sendArpDynamicInputs(e) {
    return new Promise(function(resolve) {
      let tp = Number(e.getAttribute('tp'));
      let dynamicInputs = {
        requestType: 'dynamic',
        stockCode: "{{ corp.stockCode }}",
        oc: $("input[name=oc]:checked").val(),
        arName: $("#arName").val(),
        tp: tp,
      };
      arpWs.send(JSON.stringify(dynamicInputs))
      resolve();
    });
  };
  function receiveArpDynamicData() {
    return new Promise(function(resolve) {
      arpWs.onmessage = function(e) {
        let ds = JSON.parse(e.data);
        if (ds !== null) {
          arpDynamicDataSets.push(ds);
          resolve(ds);
        } else {
          reject(new Error("no data"));
        };
      };
    });
  };
  const arpTsChartMap = [
    {
        markerLabel: "{{ corp.corpName }}",
        pathLabel: 'valLine',
        id: 'val',
        color: hexToRgb(arpChartColors[1], 1),
        style: 'circle',
    }, {
        markerLabel: "{{ corp.market }} 평균",
        pathLabel: 'avgLine',
        id: 'avg',
        color: hexToRgb(arpChartColors[0], 1),
        style: 'circle',
    }, {
        markerLabel: "{{ corp.market }} 25%",
        pathLabel: 'q1Line',
        id: 'q1',
        color: hexToRgb(arpChartColors[2], 1),
        style: 'rectRot',
    }, {
        markerLabel: "{{ corp.market }} 50%",
        pathLabel: 'q2Line',
        id: 'q2',
        color: hexToRgb(arpChartColors[0], 1),
        style: 'rect',
    }, {
        markerLabel: "{{ corp.market }} 75%",
        pathLabel: 'q3Line',
        id: 'q3',
        color: hexToRgb(arpChartColors[3], 1),
        style: 'rectRot',
    },
  ];
  const arpDistChartConfigMap = [
    {
      type: 'bar',
      label: 'hist',
      id: 'counts',
      color: hexToRgb(arpChartColors[0], .5),
      yAxisID: 'y',
    }, {
      type: 'line',
      label: 'kde',
      id: 'kde',
      color: hexToRgb(arpChartColors[0], 1),
      yAxisID: 'y1',
    }, {
      type: 'scatter',
      label: 'distValMarker',
      id: 'val',
      color: hexToRgb(arpChartColors[1], 1),
      style: 'circle',
      yAxisID: 'y',
    }, {
      type: 'scatter',
      label: 'distAvgMarker',
      id: 'avg',
      color: hexToRgb(arpChartColors[0], 1),
      style: 'circle',
      yAxisID: 'y',
    }, {
      type: 'scatter',
      label: 'distQ1Marker',
      id: 'q1',
      color: hexToRgb(arpChartColors[2], 1),
      style: 'rectRot',
      yAxisID: 'y',
    }, {
      type: 'scatter',
      label: 'distQ2Marker',
      id: 'q2',
      color: hexToRgb(arpChartColors[0], 1),
      style: 'rect',
      yAxisID: 'y',
    }, {
      type: 'scatter',
      label: 'distQ3Marker',
      id: 'q3',
      color: hexToRgb(arpChartColors[3], 1),
      style: 'rectRot',
      yAxisID: 'y',
    }
  ];
  function updateArpDynamicContents(e, ds) {
    return new Promise(function(resolve) {
      // update arp chart control
      let rank = (ds.rank === null) ? '-':ds.rank;
      $(e).find('.result-cell-rank').append(rank);
      let pct = (ds.pct === null) ? '-':`${(ds.pct*100).toFixed(2)}%`
      $(e).find('.result-cell-pct').append(pct);
      let evalLk = (ds.eval === null) ? '-': (
        (ds.eval === 'highest') ? '매우 높음': (
          (ds.eval === 'higher') ? '높음': (
            (ds.eval === 'high') ? '다소 높음': (
              (ds.eval === 'mid') ? '중간 수준': (
                (ds.eval === 'low') ? '다소 낮음': (
                  (ds.eval === 'lower') ? '낮음': '매우 낮음'
                )
              )
            )
          )
        )
      );
      let redEvals = ['highest', 'higher'];
      let blueEvals = ['lowest', 'lower'];
      let txtColor = (redEvals.includes(ds.eval)) ? 'danger': (
        (blueEvals.includes(ds.eval) ? 'primary': 'dark')
      );
      $(e).find('.result-cell-eval').append(evalLk).addClass(`text-${txtColor}`);

      // update path and markers on ts chart
      for (tm of arpTsChartMap) {
        // marker
        let tsMarker = arpTsChart.data.datasets.find(ds =>
          ds.label === tm.markerLabel
        );
        if (tsMarker === undefined) {
          arpTsChart.data.datasets.push({
            type: 'scatter',
            label: tm.markerLabel,
            data: [{
              x: dateFormatter(ds.tp),
              y: ds[tm.id]
            }],
            backgroundColor: tm.color,
            pointStyle: tm.style,
            radius: 7,
          });
        } else {
          tsMarker.data = [{
            x: dateFormatter(ds.tp),
            y: ds[tm.id],
          }];
        };

        // path
        if (tm.pathLabel !== 'valLine') {
          let tsPath = arpTsChart.data.datasets.find(ds =>
            ds.label === tm.pathLabel
          );
          if (tsPath === undefined) {
            arpTsChart.data.datasets.push({
              type: 'line',
              label: tm.pathLabel,
              data: [{
                x: dateFormatter(ds.tp),
                y: ds[tm.id]
              }],
              backgroundColor: tm.color,
              pointStyle: tm.style,
              radius: 3,
            });
          } else {
            if (tsPath.data.x !== ds.tp) {
              tsPath.data.push({
                x: dateFormatter(ds.tp),
                y: ds[tm.id],
              });
              tsPath.data.sort((a,b) => (a.x > b.x) ? 1: ((b.x > a.x) ? -1:0));
            };
          };
        };
      };
      arpTsChart.update();

      // update dist

      // hist and kde
      arpDistChart.data.labels = ds.bins
      for (dm of arpDistChartConfigMap) {
        let distItem = arpDistChart.data.datasets.find(ds =>
          ds.label === dm.label
        );
        distData = (dm.type === 'scatter') ? [{x: ds[dm.id], y: 0}]:ds[dm.id];
        distPointRadius = (dm.type === 'scatter') ? 7:0;
        if (distItem === undefined) {
          arpDistChart.data.datasets.push({
            type: dm.type,
            label: dm.label,
            data: distData,
            backgroundColor: dm.color,
            borderColor: dm.color,
            pointRadius: distPointRadius,
            pointStyle: dm.style,
            yAxisID: dm.yAxisID,
          })
        } else {
          distItem.data = distData
        };
      };

      // markers on dist
      arpDistChart.update();
    });
  };
  function activateArpControl(e, ds) {
    return new Promise(function(resolve) {
      $(e).find('.result-cell').remove();
      $(e).append(`
        <td class="result-cell result-cell-rank"></td>
        <td class="result-cell result-cell-pct"></td>
        <td class="result-cell result-cell-eval"></td>
      `);
      resolve(ds);
    })
  };
  function updateArpDynamic(e) {
    deactivateArpControl(e)
      .then(() => getArpDynamicData(e))
      .then(ds => activateArpControl(e, ds))
      .then(ds => updateArpDynamicContents(e, ds))
  };
  $(document).ready(function() {
    updateArpStatic();
  });
</script>

<script>
  // fa chart
  const faChartColors = [
    '#457CA2', "#DC3912", "#FF9900", "#109618", "#990099", "#3B3EAC", "#0099C6",
    "#DD4477", "#66AA00", "#B82E2E", "#316395", "#994499", "#22AA99", "#AAAA11",
    "#6633CC", "#E67300", "#8B0707", "#329262", "#5574A6", "#651067"
  ];

  // create fa chart
  const faChartConfig = {
    type: 'scatter',
    data: {
      labels: [],
      datasets: [],
    },
    options: {
      responsive: true,
      scales: {
        "yl": {
          type: 'logarithmic',
          display: true,
          positon: 'left',
          title: {
            text: '값 (KRW)',
            display: true,
          },
          ticks: {
            callback: function(value) {
              if (value > 999 && value < 1e6) {
                return (value/1e3).toFixed(0) + 'K'
              } else if (value >= 1e6 && value < 1e9) {
                return (value/1e6).toFixed(0) + 'M'
              } else if (value >= 1e9 && value <1e12) {
                return (value/1e9).toFixed(0) + 'B'
              } else if (value >= 1e12) {
                return (value/1e12).toFixed(0) + 'T'
              }
            }
          }
        },
        "yr": {
          type: 'linear',
          display: true,
          position: 'right',
          title: {
            text: '변동율 (%)',
            display: true,
          },
          grid: {
            drawOnChartArea: false,
          },
        }
      },
    }
  };
  const faChart = new Chart(
    document.getElementById('faChart'),
    faChartConfig
  );

  // faSearch
  function activateFaSearch() {
    return new Promise(function(resolve) {
      $('#selectCell')[0].innerHTML = `
        <select class="form-select" id="ocSelected">
          <option value="CFS" selected>연결</option>
          <option value="OFS">별도</option>
        </select>
      `;
      $('#searchCell')[0].innerHTML = `
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control" type="text" id="faSearched" placeholder="당기순이익(손실)">
        </div>
      `;
      $('#faSearchResult')[0].innerHTML = `
        <button class="btn btn-close m-3" onclick="deactivateFaSearch()"></button>
        <div class="d-flex flex-row">
          <p class="form-text m-3 fw-bold">매치된 계정</p>
          <div class="m-3" id="faMatched">
            <span class="form-text m-3">계정명을 입력하세요</span>
          </div>
        </div>
        <div>
          <p class="form-text m-3 fw-bold">조회 가능 계정 목록</p>
          <div class="m-3" id="faFiltered-bs">
            <p class="form-text">재무상태표</p>
          </div>
          <div class="m-3" id="faFiltered-pl">
            <p class="form-text">손익계산서</p>
          </div>
          <div class="m-3" id="faFiltered-cf">
            <p class="form-text">현금흐름표</p>
          </div>
        </div>
      `;

      resolve(JSON.parse("{{ fa_viewer.fa_all | escapejs }}"))
    });
  };
  function deactivateFaSearch() {
    $('#selectCell')[0].innerHTML = '-';
    $('#searchCell')[0].innerHTML = '-';
    $('#faSearchResult')[0].innerHTML = '';
  };
  function koreanAscending(a, b) {
    return (a.lk < b.lk)?-1:(a.lk == b.lk)?0:1;
  };
  function findResult(faAll) {
    $('#ocSelected').change(function() {

      // subset the universe
      var oc = $(this).val()

      $('#faSearched').keyup(function() {

        // reset result wrapper
        $('#faFiltered-bs').find('span').remove();
        $('#faFiltered-pl').find('span').remove();
        $('#faFiltered-cf').find('span').remove();

        // filter
        var fltrd = faAll.filter( x =>
          (x.oc === oc)
          && (x.lk.includes($(this).val()))
        ).sort(koreanAscending);

        // fill the results
        for (f of fltrd) {
          var resId = `faFiltered-${f.ft_div.toLowerCase()}`;
          $(`#${resId}`).append(`
            <span class="badge rounded-pill bg-secondary" type="button" onclick="queryFaData('${stockCode}', '${f.oc}', '${f.nm}')">
              ${f.lk}
            </span>
          `)
        };

        // match
        $('#faMatched').find('span').remove();
        var matched = faAll.find( x =>
          (x.oc == oc)
          && (x.lk == $(this).val())
        );
        if (matched === undefined) {
          $('#faMatched').append(`
            <span class="form-text">매치된 계정이 없습니다. 계정명을 정확히 입력해주세요.</span>
          `)
        } else {
          $('#faMatched').append(`
            <span class="badge rounded-pill bg-success" type="button" onclick="queryFaData('${stockCode}', '${matched.oc}', '${matched.nm}')">
              ${matched.lk}
            </span>
          `)
        };
      }).trigger('keyup');
    }).trigger('change');
  }
  function faSearch() {
    activateFaSearch()
    .then(faAll => findResult(faAll))
  };

  // websocket
  function addFaChartControlRow(oc, faName) {
    let rowId = `faChartControlRow-${oc}-${faName}`
    return new Promise(function(resolve) {
      $('#faChartControl tbody').append(`
      <tr id=${rowId}>
        <th scope="row"><button class="btn btn-close remove-fa-row"></button></th>
        <td class="result-cell text-center" colspan="6">
          <div class="spinner-grow spinner-grow-sm text-success" role="status"></div>
        </td>
      </tr>
      `);
      resolve(); // resolve dummy for promise chaining
    });
  };
  function createFaWs() {
    return new Promise(function(resolve) {
      resolve(new WebSocket(
          `ws://${window.location.host}/ws/dashboard/stkrpt/fa`
      ));
    });
  };
  function sendFaInputs(ws, stockCode, oc, faName) {
    return new Promise(function(resolve) {
      ws.onopen = function() {
        ws.send(JSON.stringify({
          stockCode: stockCode,
          oc: oc,
          faName: faName,
        }))
      };
      resolve(ws);
    })
  };
  function getFaData(ws) {
    return new Promise(function(resolve) {
      ws.onmessage = function(e) {
        faData = JSON.parse(e.data);
        resolve([ws, faData]);
      };
    });
  };
  function updateFaX(faData) {
    return new Promise(function(resolve) {
      let oldT = faChart.data.labels;
      let newT = JSON.parse(faData.chart_data.t).map(tp => dateFormatter(tp));
      if (oldT.length === 0) {
        faChart.data.labels = newT;
      } else if (newT.length > oldT.length) {
        for (dt of newT) {
          for (ds of faChart.data.datasets) {
            newY = []
            for (y of ds.data) {
              let loc = oldT.indexOf(dt);
              if (loc === -1) {
                newY.push(null);
              } else {
                newY.push(y);
              };
            };
          };
        };
        faChart.data.labels = newT;
      };
      resolve();
    })
  };
  function updateFaY(faData) {
    return new Promise(function(resolve) {
      let cleanValue = [];
      let cleanGrowth = [];

      let newT = JSON.parse(faData.chart_data.t).map(tp => dateFormatter(tp));
      let newVal = JSON.parse(faData.chart_data.y_val);
      let newGrowth = JSON.parse(faData.chart_data.y_growth);
      for (dt of faChart.data.labels) {
        let loc = newT.indexOf(dt);
        if (loc === -1) {
          cleanValue.push(null);
          cleanGrowth.push(null);
        } else {
          cleanValue.push(newVal[loc]);
          cleanGrowth.push(newGrowth[loc]);
        };
      };

      let fasInfo = JSON.parse(faData.fas_info)
      let ocLk = (fasInfo.oc === 'CFS') ? '연결':'별도';
      let valLabel = `${fasInfo.lk} (${ocLk})`;
      let growthLabel = `${fasInfo.lk} 변동율 (${ocLk})`;
      let dcolor = faChartColors.shift();
      faChart.data.datasets.push({
        type: 'line',
        label: valLabel,
        data: cleanValue,
        borderColor: dcolor,
        yAxisID: 'yl',
      });
      faChart.data.datasets.push({
        type: 'bar',
        label: growthLabel,
        data: cleanGrowth,
        backgroundColor: hexToRgb(dcolor, .5),
        borderColor: hexToRgb(dcolor, .5),
        yAxisID: 'yr',
      });
      faChart.update();

      resolve();
    });
  };
  function updateFaChartControl(faData) {
    let fasInfo = JSON.parse(faData.fas_info);
    let rowId = `faChartControlRow-${fasInfo.oc}-${fasInfo.nm}`
    let row = $(`#${rowId}`);
    let ocLk = (fasInfo.oc === 'CFS') ? '연결':'별도';
    let valLabel = `${fasInfo.lk} (${ocLk})`;
    let growthLabel = `${fasInfo.lk} 변동율 (${ocLk})`;
    let status = (faData.chart_data === null) ? '데이터 없음':'전시 중';
    let statusColor = (faData.chart_data === null) ? 'text-danger':'text-success';

    row.find('.result-cell').remove();
    row.append(`
      <td class="result-cell result-cell-oc">${ocLk}</td>
      <td class="result-cell result-cell-lk">${fasInfo.lk}</td>
      <td class="result-cell result-cell-path">${fasInfo.path}</td>
      <td class="result-cell result-cell-status ${statusColor}">${status}</td>
      <td class="result-cell value-handler">
        <div class="form-check form-switch">
          <input type="checkbox" class="form-check-input" data-control="${valLabel}" checked>
        </div>
      </td>
      <td class="result-cell growth-handler">
        <div class="form-check form-switch">
          <input type="checkbox" class="form-check-input" data-control="${growthLabel}" checked>
        </div>
      </td>
    `);
  };
  function updateFaContents(ws, faData) {
    return new Promise(function(resolve) {
      ws.close();
      updateFaChartControl(faData);
      updateFaX(faData)
        .then(() => updateFaY(faData));
      resolve();
    });
  };
  function activateFaChartControl() {
    $('.value-handler input').change(function() {
      let dataLabel = $(this).attr('data-control')
      let data = faChart.data.datasets.find(x => x.label === dataLabel)
      if ($(this).is(":checked")) {
        data.hidden = false
      } else {
        data.hidden = true
      }
      faChart.update();
    });
    $('.growth-handler input').change(function() {
      let dataLabel = $(this).attr('data-control')
      let data = faChart.data.datasets.find(x => x.label === dataLabel)
      if ($(this).is(":checked")) {
        data.hidden = false
      } else {
        data.hidden = true
      }
      faChart.update();
    });
    $('.remove-fa-row').on('click', function() {
      let row = $(this).closest('tr')
      row.find('input').each(function(i) {
        let dataLabel = $(this).attr('data-control');
        if (i === 0) {
          let dcolor = faChart.data.datasets.find(x =>
            x.label === dataLabel).borderColor;
          faChartColors.unshift(dcolor)
        };
        faChart.data.datasets = faChart.data.datasets.filter(x =>
          x.label != dataLabel
        );
        if (faChart.data.datasets.length === 0) {
          faChart.data.labels = [];
        };
        faChart.update();
      });
      row.remove();
    });
  };

  function queryFaData(stockCode, oc, faName) {
    deactivateFaSearch();
    addFaChartControlRow(oc, faName);
    createFaWs()
      .then(ws => sendFaInputs(ws, stockCode, oc, faName))
      .then(ws => getFaData(ws))
      .then(([ws, faData]) => updateFaContents(ws, faData))
      .then(() => activateFaChartControl())
  };

  $(document).ready(function() {
    presets = ['EquityAttributableToOwnersOfParent', 'ProfitLoss'];
    for (faName of presets) {
      queryFaData(stockCode, 'CFS', faName)
    };
  });


</script>
