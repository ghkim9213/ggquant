{% extends '../index.html' %}
{% load static %}
{% load humanize %}
{% block title %}Dashboard-Stock Reports{% endblock %}

{% block css %}
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css"> -->
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">


{% endblock %}

{% block content %}
<div class="container py-4">

<!-- search banner   -->
<div class="py-lg-5">
  <div class="jumbotron text-center">
    <h1 class="display-4">Find your own insight!</h1>
    <div class="d-flex flex-row justify-content-center">
      <form method="post" class="py-3 col-md-4 col-lg-4" id="corpSearchForm" onsubmit="return convertToStockCode()">
        {% csrf_token %}
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input class="form-control form-control-lg" id="corpSelected" name="stock_code" type="text" type="search" placeholder="Search">
        </div>
      </form>
    </div>
    <p class="lead">Don't forget to pray.</p>
  </div>
</div>
<p>[주의사항/출처/...]</p>
<hr class="my-4">

<!-- report -->
<div class="py-lg-3">

<!-- report header -->
<div class="mb-4" id="stkrpt-header">
  <div class="col-md-9 col-lg-9">
    <h1>{{corp.corpName}} ({{corp.stockCode}})</h1>
  </div>
  <table id="corpInfo" class="table table-hover">
    <tr>
      <th>상장구분</th>
      <td>{{ corp.market }}</td>
      <th>상장일</th>
      <td>{{ corp.listedAt }}</td>
    </tr>

    <tr>
      <th>CEO</th>
      <td>{{ corp.ceo }}</td>
      <th>결산월</th>
      <td>{{ corp.fye }}</td>
    </tr>
    <tr>
      <th>업종</th>
      <td>{{ corp.industry }}</td>
      <th>홈페이지</th>
      <td>
        {% if corp.homepage %}
        <a href="{{ corp.homepage }}" class="text-decoration-none">{{ corp.homepage }}</a>
        {% else %}
        -
        {% endif %}
      </td>
    </tr>
    <tr>
      <th>주요 상품</th>
      <td colspan="3">{{ corp.product }}</td>
    </tr>
  </table>
</div>

<!-- recent history -->
<div class="mb-4" id="recentHistory">
  <h4 class="mb-3 fw-bold">{{ corp.corpName }} ({{ corp.stockCode }}) 관련 오픈데이터 최근 변경사항</h4>
  <ul class="list-group">
    {% for k, v in recent_history.items %}
    <li class="list-group-item list-group-item-action bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#historyItems{{ forloop.counter }}" aria-expanded="false" aria-controls="historyItems{{ forloop.counter }}">{{ k }}</li>
    <div class="collapse {% if forloop.counter == 2 %}show{% endif %}" id="historyItems{{ forloop.counter }}">
      {% if v|length == 0 %}
      <li class="list-group-item">최근 {{ k }}에 대한 변경사항이 존재하지 않습니다.</li>
      {% else %}
      {% for h in v %}
      <li class="list-group-item text-truncate">{{ h }}</li>
      {% endfor %}
      {% endif %}
    </div>
    {% endfor %}
  </ul>
</div>

<!-- ar viewer -->
<h4 class="mb-3 fw-bold">재무비율</h4>
<div class="mb-4" id="larViewer">
  <p class="mb-3 fw-bold">재무비율 현황</p>
  <ul class="nav nav-tabs">
    {% for oc in lar_viewer.keys %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if forloop.first %}active{% endif %}" id="lar{{ oc }}-tab" data-bs-toggle="tab" data-bs-target="#lar{{ oc }}" type="button" role="tab" aria-controls="lar{{ oc }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
        {% if oc == 'CFS' %}연결{% else %}별도{% endif %}
      </button>
    </li>
    {% endfor %}
  </ul>
  <div class="tab-content">
    {% for oc, data in lar_viewer.items %}
    <div class="tab-pane fade {% if forloop.first %}show active{% endif %} mt-4" id="lar{{ oc }}" role="tabpanel" aria-labelledby="lar{{ oc }}-tab">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>지표명</th>
            <th>지표구분</th>
            <th>회계연도</th>
            <th>분기</th>
            <th>값</th>
            <th>상위</th>
          </tr>
        </thead>
        <tbody>
          {% for k, v in data.items %}
          <tr>
            <th>{{ k.labelKor }}</th>
            <td>{{ k.div }}</td>
            <td>{{ v.by }}</td>
            <td>{{ v.bq }}</td>
            <td>{% if v.value %}{{ v.value }}{% else %}-{% endif %}</td>
            <td>{% if v.value %}{{ v.rankpct|floatformat:"2" }}% (집계대상 {{ v.count|intcomma }}개 종목 중 {{ v.rank|floatformat:"0"|intcomma }}위){% else %}-{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endfor %}
  </div>
</div>

<!-- account ratio time series viewer -->
<div class="mb-4" id="artsViewer">
  <p class="mb-3 fw-bold">재무비율 변동</p>
  <!-- select chart -->
  <div id="selectArts">
    <!-- select method     -->
    <div class="input-group mb-3">
      <span class="input-group-text" id="tsMethod-addon">재무제표 구분</span>
      <div class="form-control" aria-describedby="tsMethod-addon">
        {% for oc in ar_ts_viewer.form.method_choices %}
        <div class="form-check form-check-inline">
          <input type="radio" class="form-check-input" name="ocChecked" value="{{ oc }}" {% if forloop.first %}checked{% endif %}>
          <label for="{{ oc }}" class="form-check-label" >{% if oc == 'CFS' %}연결{% else %}별도{% endif %}</label>
        </div>
        {% endfor %}
      </div>
    </div>
    <!-- select ar -->
    <div class="input-group mb-3">
      <span class="input-group-text" id="arSelected-addon">재무비율 선택</span>
      <select name="arSelected" id="arSelected" class="form-select" aria-describedby="arSelected-addon">
        {% for ar in ar_ts_viewer.form.ar_choices %}
        <option value="{{ ar.name }}" {% if forloop.first %}selected{% endif %}>{{ ar.labelKor }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- view table -->
  <div class="table-responsive">
    <table class="table table-hover" id="artsTable"></table>
  </div>

  <!-- view chart -->
  <div>
    <canvas id="artsChart"></canvas>
  </div>

</div>


<!-- fs viewer -->
<div class="mb-4" id="fsViewer">
  <h4 class="mb-3 fw-bold">재무제표 검색</h4>
  <div class="formbox">
    {% if fs_viewer.fs_list == None %}
    <p class="text-center text-muted fs-2">조회 가능한 재무제표가 존재하지 않습니다.</p>
    {% else %}
    <form method="post" id="fsQueryForm" class="mb-3">
      {% csrf_token %}
      <input type="hidden" name="stock_code" value="{{ corp.stockCode }}">
      <input type="hidden" name="fsFilter" value="true">
      <!-- <input type="hidden" name=""> -->
      <div class="input-group mb-3">
        <span class="input-group-text col-md-2">구분</span>
        <div class="form-control col-md-10">
          <div class="form-check form-check-inline col-md-10" v-for="c in choices.ftnm">
            {% verbatim %}
            <input type="radio" name="ftnm_selected" v-bind:value="c" v-model="selected.ftnm" @change="validateQuery">
            <!-- <input type="radio" name="ftnm_selected" v-bind:value="c" v-model="selected.ftnm" @change="validateQuery"> -->
            <label> {{ c }} </label>
            {% endverbatim %}
          </div>
        </div>
      </div>

      <div class="input-group mb-3">
        <span class="input-group-text col-md-2">회계연도</span>
        <div class="form-control col-md-10">
          <div class="form-check form-check-inline col-md-10" v-for="c in choices.by">
            {% verbatim %}
            <input type="radio" name="by_selected" v-bind:value="c" v-model="selected.by" @change="validateQuery">
            <label> {{ c }} </label>
            {% endverbatim %}
          </div>
        </div>
      </div>

      <div class="input-group mb-3">
        <span class="input-group-text col-md-2">분기</span>
        <div class="form-control col-md-10">
          <div class="form-check form-check-inline col-md-10" v-for="c in choices.bq">
            {% verbatim %}
            <input type="radio" name="bq_selected" v-bind:value="c" v-model="selected.bq" @change="validateQuery">
            <label> {{ c }}분기 </label>
            {% endverbatim %}
          </div>
        </div>
      </div>
      <button class="btn btn-primary" role="submit" v-if="isValid">조회</button>
      <div v-else>
        <button class="btn btn-primary" disabled v-else>조회</button>
        {% verbatim %}<span class="inline text-danger">*{{ message }}</span>{% endverbatim %}
      </div>
    </form>
    {% endif %}
    {% if fs_viewer.treeview_data != None %}
    <table id="fs" class="table table-secondary table-striped">
      <thead>
        <th scope="col">{{ fs_viewer.treeview_data.title }}</th>
        <th scope="col" class="text-end">
          <div class="btn-group" role="group">
            <button id="expander" type="button" class="btn btn-secondary btn-sm">모두 펼치기</button>
            <button id="collapser" type="button" class="btn btn-outline-secondary btn-sm">모두 접기</button>
          </div>
        </th>
      </thead>
      <tbody>
        {% for fd in fs_viewer.treeview_data.data %}
        <tr data-node-id="{{ fd.idt }}" data-node-pid="{{ fd.pidt }}">
          <td>{{ fd.obj.labelKor }} {% if fd.obj.is_standard is not True %}*{% endif %}</td>
          {% if fd.obj.value != None %}
          <td class="text-end">{{ fd.obj.value | intcomma }} {{ fd.obj.currency }}</td>
          {% else %}
          <td></td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
</div>




</div>

{% endblock %}

{% block js %}

<!-- js script for searching stock -->
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" integrity="sha256-eTyxS0rkjpLEo16uXTS0uVCS4815lc40K2iVpWDvdSY=" crossorigin="anonymous"></script>
<script>
  const searchData = JSON.parse("{{ search_data | escapejs }}");
  $("#corpSelected").autocomplete({
      source: Object.keys(searchData),
      minLength: 2,
      // autoFocus: true,
  });
  function convertToStockCode() {
    var corpSelected = document.getElementById("corpSelected")
    var corpName = corpSelected.value
    if (Object.keys(searchData).includes(corpName)) {
      // console.log(corpName)
      corpSelected.value = searchData[corpName];
      return true;
    } else {
      alert('no such stock')
      return false;
    }
    // console.log(selectedCorp.value)
  }
</script>

<!-- js script for chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // default chart and table
  const corpName = "{{ corp.corpName }}"
  const market = "{{ corp.market }}"
  const labels = JSON.parse("{{ ar_ts_viewer.chart.labels | escapejs }}");
  const dataAll = JSON.parse("{{ ar_ts_viewer.chart.data | escapejs }}");
  const defaultRow = dataAll[0]


  // table
  $(document).ready(function() {
    // header
    const artsTable = document.getElementById('artsTable')
    var head = document.createElement('thead');
    var hrow = document.createElement('tr');
    for (h of labels) {
      var hcell = document.createElement('th');
      var hval = document.createTextNode(h);
      hcell.appendChild(hval);
      hrow.appendChild(hcell);
    }
    head.appendChild(hrow);

    // body
    var body = document.createElement('tbody');
    var brow = document.createElement('tr');
    for (v of defaultRow.value) {
      var bcell = document.createElement('td');
      if ( v === null ) {
        var bval = document.createTextNode('-');
      } else {
        var bval = document.createTextNode(Number(v).toFixed(4));
      }
      bcell.appendChild(bval);
      brow.appendChild(bcell);
    }
    body.appendChild(brow);
    artsTable.appendChild(head);
    artsTable.appendChild(body);
  })


  // chart
  const data = {
    labels: labels,
    datasets: [{
        label: `${corpName} ${defaultRow.label}`,
        backgroundColor: 'rgb(255, 99, 132)',
        borderColor: 'rgb(255, 99, 132)',
        data: defaultRow.value,
      }, {
        label: `${market} ${defaultRow.label} 평균`,
        data: defaultRow.mean,
        backgroundColor: "#084de0",
        borderColor: "#084de0",
        borderDash: [5, 5]
      }, {
        label: `${market} ${defaultRow.label} 중위`,
        data: defaultRow.median,
        backgroundColor: "#50C878",
        borderColor: "#50C878",
        borderDash: [5, 5]
      }
    ]
  };

  const config = {
    type: 'line',
    data: data,
    options: {}
  };

  const artsChart = new Chart(
    document.getElementById('artsChart'),
    config
  );

  // update
  $(document).ready(function() {
    $('#selectArts').change(function() {
      var ocChecked = $('input[name=ocChecked]:checked').val()
      var arSelected = $('#arSelected').val()
      var matched = dataAll.find( x =>
        (x.method === ocChecked)
        && (x.name === arSelected)
      )
      if (matched != null) {
        var brow = $('#artsTable tbody tr')[0]
        for (let [i, v] of matched.value.entries()) {
          if (v === null) {
            brow.cells[i].innerHTML = '-'
          } else {
            brow.cells[i].innerHTML = Number(v).toFixed(4)
          }
          // console.log(v.toLocaleString(undefined, floatformat))
        }
        artsChart.data.datasets[0].label = matched.label;
        artsChart.data.datasets[0].data = matched.value;

        artsChart.data.datasets[1].label = `${market} ${matched.label} 평균`;
        artsChart.data.datasets[1].data = matched.mean;

        artsChart.data.datasets[2].label = `${market} ${matched.label} 중위`;
        artsChart.data.datasets[2].data = matched.median;

        artsChart.update();
      } else {
        alert('no such series')
      }
    })
  });
</script>

<!-- js script for searching fs -->
<script>
  const fsAll = JSON.parse("{{ fs_viewer.fs_list | escapejs }}")
  Vue.createApp({
    data() {
      return {
        fsAll: fsAll,
        choices: {
            ftnm: [... new Set(fsAll.map(x => x.ftnm))],
            // labelKor: [... new Set(fsAll.map(x => x.label_kor))],
            by: [... new Set(fsAll.map(x => x.by))],
            bq: [... new Set(fsAll.map(x => x.bq))],
        },
        selected: {
          ftnm: null,
          by: null,
          bq: null,
        },
        isValid: false,
        message: '모든 항목을 선택하세요.',
      }
    },
    methods: {
      validateQuery() {
        allChecked = !Object.values(this.selected).includes(null)
        fsExists = this.fsAll.some( x =>
          JSON.stringify(this.selected) === JSON.stringify(x)
        )
        this.isValid =  allChecked && fsExists
        if ( this.isValid ) {
          this.message = null
        } else if ( !allChecked ) {
          this.message = '모든 항목을 체크하세요'
        } else if ( !fsExists ) {
          this.message = '해당 재무제표가 존재하지 않습니다.'
        }
      },
    }
  }).mount("#fsQueryForm")
</script>

<script src="{% static 'js/jquery-simple-tree-table.js' %}"></script>
<script>
  $('#fs').simpleTreeTable({
    expander: $('#expander'),
    collapser: $('#collapser'),
  });
</script>
{% endblock %}
